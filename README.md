# TODO

- [X] Шапку подредачить, кнопки скрыть
- [X] Сделать контроллер пользователя
- [X] Создать второго пользователя
- [x] Добавить на сервер проверку того, что роль вопрошающего - администратор
- [X] Изменить API так, чтобы можно было видеть список курсов
  - [X] Поменять API под разные курсы (отдельные директории, в каждой скорее всего будут лежать свои папки `course` и `hero`)
  - [X] Переделать API на клиенте
  - [X] Сделать главную страницу сайта
- [X] Сделать страницу администратора
- [X] Загрузка ZIP-архивов через админа
- [X] Сделать обработку курсов по загрузке ZIP-архива на сервер
- [ ] Реализация миссий
  - [ ] Переименовать "практики" в "миссии"
  - [ ] Разработать формат задания миссий в курсе
    - [ ] Для формата "просто текст"
    - [ ] Для формата "тестовая задача"
  - [ ] Разработать страницу для отображения миссий
  - [ ] Сделать навигацию к миссиям, если они доступны после тестов по уроку

- [ ] Движок геймификации
  - [ ] Разработка системы событий и соответствующих реакций на события
    - [ ] Разработка системы событий
    - [ ] Интеграция системы событий с сайтом
    - [ ] Разработка системы реакций на события
  - [ ] Реализация монологов (диалога героя с пользователем)
    - [ ] Реализация объектной части
    - [ ] Реализация конструктора монологов
    - [ ] Реализаця страницы монолога
    - [ ] Добавление конструктора монолога в редактор геймификации курса
    - [ ] Загрузка json-представления монолога на сервер для хранения в курсе
    - [ ] Подгрузка монологов с сервера по запросам
  - [ ] Реализация диалогов (диалог одного героя с другим героем)
    - [X] Реализация объектной части
    - [ ] Реализация конструктора диалогов
    - [X] Реализация страницы диалога
    - [ ] Добавление конструктора диалога в редактор геймификации курса
    - [ ] Загрузка json-представления диалога на сервер для хранения в курсе
    - [X] Подгрузка диалогов с сервера по запросам
  - [ ] Реализация конструктора геймификации в курсе (с отображением текущей геймификации и возможностью встраивания новых элементов геймификации)
  - [ ] Разработка системы достижений (в частности - выдача новых персонажей)
  - [ ] Проработать систему сюжетных баллов
  - [ ] Проработать систему тестовых баллов
  - [ ] Реализация приветственного экрана (экран, который покажется пользователю единожды при первом открытии курса и будет содержать вводную информацию о курсе либо его лоре)
    - [ ] Реализация объектной части
    - [ ] Реализация конструктора (если это можно назвать так)
    - [ ] Реализация страницы 
    - [ ] Добавление конструктора в редактор геймификации
    - [ ] Загрузка json-представления на сервер
    - [ ] Подгрузка с сервера по запросам
- [ ] Сохранение текущей эмоции у персонажа по пользователю (делать в конце) ???????????

- [ ] Переделать JSONки геймификации в курсе на другой формат (чтобы можно было задавать несколько ивентов в 1 файле)


## Определить API:

- [X] Получение списка курсов
- [X] Получение информации о курсе (список модулей и уроков)
- [X] Получение текста урока
- [X] Получение фраз персонажа на лекции
- [X] Получение тестовых заданий для определённого теста
- [X] Получение фраз персонажа на тест

## Реализовать API

- [X] Получение списка курсов
- [X] Получение информации о курсе (список модулей и уроков)
- [X] Получение текста урока
- [X] Получение фраз персонажа на лекции
- [X] Получение тестовых заданий для определённого теста
- [X] Получение фраз персонажа на тест

## Структура геймификации

## Какая информация о пользователе собирается

1. Какие уроки прошёл пользователь (теоретическая часть, тестовая часть)
2. Сколько баллов получил пользователь за каждый из тестов (баллы за тест = сумма баллов за все задачи этого теста)
3. Какие достижения получил пользователь
4. Сколько баллов получил пользователь по дополнительным сюжетным переменным

## Какие события и реакции на них присутствуют на курсе

События в курсе делятся на локальные (не меняющиеся от сюжета, возникающие только в пределах одной страницы) и глобальные (возникающие независимо от текущей страницы).

### Локальные события

Поддерживаются следующие локальные события:

1. На странице теории:
   1. Событие, когда пользователь дочитал до определённой части теории
   2. Событие, когда пользователь читал теорию дольше определённого времени
2. На странице тестирования:
   1. Событие, когда пользователь думает над текущей попыткой ответа
   2. Событие, когда пользователь ответил правильно с N-ой попытки
   3. Событие, когда пользователь ответил неправильно N-ый раз

### Реакции на локальные события

Реакции на них представляют собой фразу главного героя с его иконкой. 

#### Реакции на странице теории

Реакции на странице теории задаются следующим образом:

1 - В директории курса (`course`, `course/module xx`, `course/module xx/lesson yy`) создаётся файл с названием `hero-phrases.json` с примерно следующим содержанием:

```json
{
    "<название-реакции-по-времени-без-пробелов>": {
        "phrase": "<Фраза главного героя>",
        "emotion": "<Эмоция главного героя>",
        "onTime": <время-задрежки-появления-реакции-в-секундах>
    },
    "<название-реакции-по-скроллу-без-пробелов>": {
        "phrase": "<Фраза главного героя>",
        "emotion": "<Эмоция главного героя>"
    }
}
```

Количество реакций в пределах одного файла может быть неограничено. Реакций с одинаковым названием в одном файле быть не должно. Количество файлов также неограничено, но в одной папке может быть только 1 такой файл (например, в папке `course/module 1` может быть только 1 такой файл, но в папке `course/module 1/lesson 1` может быть ещё 1 такой файл).

Реакции на сервере для урока ищутся в следующем порядке. Допустим, необходимо найти реакцию для урока 2, находящейся в модуле 1:

1. Реакция ищется в файле `hero-phrases.json`, находящемся в папке с уроком 2 (если файл там есть);
2. Если реакция не нашлась, то тогда реакция ищется в файле `hero-phrases.json`, находящемся в папке с модулем 1 (если файл там есть);
3. Если реакция не нашлась, то тогда реакция ищется в файле `hero-phrases.json`, находящемся в папке с курсом (если файл там есть);
4. Если реакция не нашлась, то возвращается ошибка.

2 - В файле с теорией по уроку (в расширении `.md`) добавляется строка следующего формата:

```markdown
@action="<название-реакции>"
```

Если реакция будет не найдена, на странице теории в тексте отобразится соответствующая ошибка

#### Реакции на странице тестирования

Реакции на странице тестирования задаются в файле `hero/test-reactions.json` в следующем формате:

```json
{
    "onIdle": {
        "attempts": {
            "1": {
                "emotion": "<Эмоция персонажа>",
                "phrases": [
                    "Набор",
                    "Фраз, которые",
                    "Будут выбираться",
                    "случайным образом"
                ]
            },
            "2-3": {
                "emotion": "<Эмоция персонажа>",
                "phrases": [
                    "789",
                    "890"
                ]
            },
            "4+": {
                "emotion": "<Эмоция персонажа>",
                "phrases": [
                    "112312",
                    "123123123",
                ]
            }
        }
    },
    "onError": {
        "attempts": {
            ...
        }
    },
    "onSuccess": {
        "attempts": {
            ...
        }
    }
}
```

Всего есть три типа реакций:

1. `onIdle` - обучающийся думает над ответом в тесте
2. `onSuccess` - обучающийся ответил верно
3. `onError` - обучающийся ответил неверно

Для каждого типа реакций определяется поле `attempts`, ставящее в соответствие номер попытки к реакции на эту попытку. Номер попытки может задаваться в одном из трёх форматов:

1. `<номер>` - реакция на указанный номер попытки;
2. `<номер1>-<номер2>` - реакция на указанный диапазон номеров попытки;
3. `<номер>+` - реакция на указанный номер попытки и следующие попытки.

Для каждого типа реакций, номера не должны повторяться (а диапазоны - пересекаться). Также не должно быть пропусков значений. Желательно располагать номера по порядку. Последним номером не обязательно должен быть `<номер>+`, вместо него может располагаться любой другой номер другого формата.

Реакции задаются в следующем формате:

```json
{
    "emotion": "<Эмоция персонажа>",
    "phrases": [
        "Набор",
        "Фраз, которые",
        "Будут выбираться",
        "случайным образом"
    ]
}
```

### Глобальные события

Глобальные события представляют собой события, возникающие по мере прохождения курса. Полный перечень допустимых для использования автором курса событий следующий:

1) по началу курса `onCourseStart`
2) по окончании курса `onCourseEnd`
3) по началу модуля `onModuleStart`
4) по окончании модуля `onModuleEnd`
5) по началу урока `onLessonStart`
6) по окончании урока `onLessonEnd`
7) по началу тестирования `onTestStart`
8) по завершению тестирования `onTestEnd`
9) по набору баллов `onPointsRetrieve(<имя переменной>, <число очков>)`

События вызываются по следующей логике:

- События начала урока или теста - если урок или тест ещё не был пройден и, соответственно, урок или тест был открыт, то вызывается данное событие;
- Событие окончания урока или теста - если урок или тест ещё не был пройден, и, соответственно, урок или тест был пройден до конца, то вызывается данное событие;
- Событие начала модуля - если пользователь открыл урок или тест данного модуля, и при этом он ещё не прошёл ни одного урока или теста данного модуля;
- Событие конца модуля - если пользователь закончил урок или тест данного модуля, и при этом все остальные уроки и тесты данного модуля пройдены;
- Событие начала курса - если пользователь открыл урок или тест, и при этом он ещё не прошёл ни одного урока или теста;
- Событие конца курса - если пользователь закончил урок или тест, и при этом он уже прошёл все остальные уроки и тесты;
- Событие по набору баллов - если пользователь набрал больше или столько же баллов по указанной переменной, то срабатывает событие. 

Автору курса не нужно непосредственно указывать параметры событий 1-8. Вместо этого, файл соответствующей реакции на событие должен лежать в соответствующей ему директории:

1. Для обработки событий начала и окончания курса - в корневой директории курса (`course/`);
2. Для обработки событий начала или окончания модуля - в корневой директории соответствующего модуля (`course/module XX/`);
3. Для обработки событий начала или окончания урока или тестирования - в корневой директории соответствующего урока (`course/module XX/lesson YY/`).

### Реакции на глобальные события

На данный момент поддерживаются следующие типы реакций:

- Отобразить диалог двух игровых персонажей

#### Реакция "диалог"

Реакция "диалог" представляет из себя диалог двух игровых персонажей и поддерживает следующий функционал:

- Отобразить фразу героя (с его изображением)
- Выдать достижение обучающемуся
- Выдать определённое число баллов по определённой сюжетной переменной
- Сделать ветвление диалога по условию (по числу баллов сюжетной переменной)

Файл с диалогом задаётся непосредственно в директории курса, должен иметь название, включающее в себя слово `dialog` и иметь расширение `.json`. Структура файла должна быть примерно следующей:

```json
{
    "event": "<Название события>",
    "dialog": [
        {
            "hero": "<Имя героя 1>",
            "emotion": "<Эмоция героя 1>",
            "text": "<Фраза героя 1>"
        },
        {
            "hero": "<Имя героя 2>",
            "emotion": "<Эмоция героя 2>",
            "text": "<Фраза героя 2>"
        },
        .....
    ]
}
```

В поле `dialog` могут находиться объекты четырёх различных типов. Их формат следующий.

**Отобразить фразу героя**:

```json
{
    "hero": "<Имя героя>",
    "emotion": "<Эмоция героя>",
    "text": "<Фраза героя>"
}
```

**Выдать достижение (или достижения) пользователю**:

```json
{
    "giveAchievements": [
        "Название",
        "достижений"
    ]
}
```

**Выдать баллы по сюжетным переменным**:

```json
{
    "givePoints": [
        {
            "variable": "<Название переменной 1>",
            "value": <Число баллов>
        },
        {
            "variable": "<Название переменной 2>",
            "value": <Число баллов>
        },
        ...
    ]
}
```

**Сделать ветвление диалога по сюжетной переменной**:

```json
{
    "type": "fork",
    "condition": {
        "variable": "<Название переменной, по которой будет делаться ветвление>",
        "on": {
            "<условие 1>": [
                <продолжение диалога (допускаются все те же элементы)>
            ],
            "<условие 2>": [
                <другое продолжение диалога>
            ],
            ...
        }
    }
}
```

Поддерживаются следующие форматы условий ветвления:

- `> значение`,
- `< значение`,
- `>= значение`,
- `<= значение`,
- `== значение`,
- `!= значение`,
- `else` - срабатывает, если ни одно из условий не сработало,

## Конфигурация сюжетной геймификации

Для настройки сюжетной геймификации требуется задать следующие настройки:

1. Существующие герои и их возможные герои
2. Существующие достижения, которые можно получить в процессе прохождения курса
3. Существующие сюжетные переменные, которые можно получить в процессе прохождения курса

### Конфигурация героев

Вся информация, связанная с героями, должна находиться в директории `hero` курса. Директория должна содержать файл `config.json`, в котором должны быть перечислены:

1. Герои, активные в данном курсе,
2. Имена данных героев,
3. Возможные эмоции героев (и пути до изображений с их эмоциями).

Файл должен иметь примерно следующую структуру:

```json
{
    "heroes": [
        {
            "hero": "<Имя героя по умолчанию (основной герой)>",
            "default": true,
            "emotions": {
                "<название эмоции 1>": "<путь до эмоции 1>",
                "<название эмоции 2>": "<путь до эмоции 2>",
                ...
            }
        },
        {
            "hero": "<Имя первого вспомогательного героя>",
            "emotions": {
                "<название эмоции 1>": "<путь до эмоции 1>",
                "<название эмоции 2>": "<путь до эмоции 2>",
                ...
            }
        }
    ]
}
```

Изображения с эмоциями героев должны находиться в директории, название которой совпадает с именем героя, указанном в конфиг-файле. Например, если в курсе определён герой `tag`:

```json
{
    "heroes": [
        {
            "hero": "tag",
            "default": true,
            "emotions": {
                "happy": "happy-img.png",
                ...
            }
        },
    ]
}
```

В таком случае изображения должны храниться в директории `hero/tag/` (а изображение `happy` должно находиться по пути `hero/tag/happy-img.png`). Создавать дополнительные директории внутри директории героя не запрещается (но тогда путь до изображений, находящихся во вложенных директориях, нужно указывать явно). Например:

```json
{
    "heroes": [
        {
            "hero": "tag",
            "default": true,
            "emotions": {
                "happy": "happy/happy-img.png",
                ...
            }
        },
    ]
}
```

В таком случае изображение `happy` должно находиться по пути `hero/tag/happy/happy-img.png`.

### Конфигурация достижений

Настройка существующих в курсе достижений осуществляется в файле `gaming-config.json`, который должен находиться в корневой директории курса (`/`). В этом файле должно задаваться следующее поле:

```json
{
    ...
    "achievements": [
        {
            "name": "<Название достижения>",
            "description": "<Описание достижения>",
            "image": "<Путь до изображения>"
        },
        ...
    ]
}
```

Название достижения может содержать пробелы, но должно быть коротким. Описание может быть длинным, но в пределах разумного.

Изображение может быть любым (не обязательно это должно быть изображением героя, например), но путь до изображения должен задаваться абсолютно (например, если ваш курс называется `html_course`, то путь будет выглядеть примерно так: `/html_course/hero/tag/happy-img.png`).

Количество достижений может быть неограниченным, но они должны иметь уникальные названия.

### Конфигурация сюжетных переменных

Настройка существующих в курсе сюжетных переменных осуществляется в файле `gaming-config.json`, который должен находиться в корневой директории курса (`/`). В этом файле должно задаваться следующее поле:

```json
{
    "variables": [
        "Название переменной 1",
        "Название переменной 2",
        ...
    ],
    ...
}
```

Названия переменных желательно задавать без пробелов.

Данные переменные можно использовать в первую очередь для сюжетных ветвлений в сюжетных реакциях. Также, их значения можно изменять в этих же сюжетных реакциях.

Например, можем ввести перемененную `html_master`, в процессе прохождения курса выдавать диалоги, дополнительно проверяющие знания пользователя. И если он везде ответит правильно и, соответственно, наберёт определённое число баллов, то ему можно показать какой-либо уникальный диалог, а сами диалоги в процессе усложнить (например, вместо базовой информации в диалогах рассказывать о более сложных вещях, и так далее).

Помимо указанных в данном файле переменных, существует системная переменная `tests_score`, которая хранит в себе общее число баллов пользователя, набранных за решённые тесты. Её нельзя изменить вручную, но можно получить её значение и сделать ветвление диалога на основе её значения.







